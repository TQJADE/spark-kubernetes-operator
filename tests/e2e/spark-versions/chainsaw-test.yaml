apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: spark-operator-spark-version-validation
spec:
  scenarios:
  - bindings:
      - name: "SPARK_VERSION"
        value: "3.5.1"
      - name: "SCALA_VERSION"
        value: "2.12"
      - name: "JAVA_VERSION"
        value: "17"
      - name: "IMAGE"
        value: 'apache/spark:3.5.1-scala2.12-java17-python3-r-ubuntu'
  - bindings:
      - name: "SPARK_VERSION"
        value: "3.4.1"
      - name: "SCALA_VERSION"
        value: "2.12"
      - name: "JAVA_VERSION"
        value: "11"
  steps:
    - name: install-spark-application
      try:
        - apply:
            bindings:
            - name: V_SPARK_VERSION
              value: (concat('v', replace_all(($SPARK_VERSION), '.', '_')))
            - name: V_SCALA_VERSION
              value: (concat('v', replace_all(($SCALA_VERSION), '.', '_')))
            - name: SPARK_APPLICATION_NAME
              value: (join('-', ['spark-pi', replace_all(($SPARK_VERSION), '.', '-'),
                replace_all(($SCALA_VERSION), '.', '-')]))
            - name: V_JAVA_VERSION
              value: (concat('Java', ($JAVA_VERSION)))
            - name: JARS
              value: (concat('local:///opt/spark/examples/jars/spark-examples_', join('_', [($SCALA_VERSION), ($SPARK_VERSION)])))
            - name: IMAGE
              value: (concat('apache/spark:', join('_', [($SPARK_VERSION), 'scala', ($SCALA_VERSION), 'java', ($JAVA_VERSION), 'python3-r-ubuntu'])))
            file: spark-pi.yaml
        - sleep:
            duration: 10s
    - name: verify-common-created-resources
      try:
      - assert:
          bindings:
            - name: SPARK_DRIVER_POD_NAME
              value: (join('-', ['spark-pi', replace_all(($SPARK_VERSION), '.', '-'),
                replace_all(($SCALA_VERSION), '.', '-'), '0-driver']))
            - name: SPARK_EXECUTOR_POD_NAME
              value: (join('-', ['spark-pi', replace_all(($SPARK_VERSION), '.', '-'),
                replace_all(($SCALA_VERSION), '.', '-'), '0-executor']))
            - name: SPARK_DRIVER_CONFIG_MAP_NAME
              value: (join('-', ['spark-pi', replace_all(($SPARK_VERSION), '.', '-'),
                replace_all(($SCALA_VERSION), '.', '-'), '0-spark-drv-conf-map']))
          file: "../assertions/*.yaml"







